(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{21:function(e,t,i){e.exports=i(34)},22:function(e,t,i){},34:function(e,t,i){"use strict";i.r(t);i(22);var n=i(9),s=i(3),o=i(2),a=1e6;function r(e){return a+e}var l,h=function(){function e(){Object(s.a)(this,e),this._types=void 0,this._singletons=void 0,this._types={},this._singletons={}}return Object(o.a)(e,[{key:"register",value:function(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];this.registerType(e,t,n)}},{key:"registerSingleton",value:function(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];this.registerType(e,t,n,!0)}},{key:"registerType",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._types[e]={id:e,type:t,dependencies:i,singleton:n}}},{key:"resolve",value:function(e){var t=this,i=this._types[e];if(!i)throw new Error("unregistered type");return i.dependencies.length>0?this.singleton(i,function(){var e=i.dependencies.map(function(e){return e>=a?(e-=a,function(){return t.resolve(e)}):t.resolve(e)});return new(Function.prototype.bind.apply(i.type,[null].concat(Object(n.a)(e))))}):this.singleton(i,function(){return new i.type})}},{key:"disposeSingleton",value:function(e){if(!this._singletons[e])throw new Error("trying to dispose a singleton which doesn't exist");this._singletons[e]=null}},{key:"singleton",value:function(e,t){return e.singleton?(this._singletons[e.id]||(this._singletons[e.id]=t()),this._singletons[e.id]):t()}}]),e}();!function(e){e[e.ILogger=1]="ILogger",e[e.IAssetService=2]="IAssetService",e[e.IInputTracker=3]="IInputTracker",e[e.ICore=4]="ICore",e[e.ICamera=5]="ICamera",e[e.IRenderer=6]="IRenderer",e[e.IWorldMeshBuilder=7]="IWorldMeshBuilder",e[e.IMapLoader=8]="IMapLoader",e[e.IWorld=9]="IWorld",e[e.IMouseControls=10]="IMouseControls",e[e.IPlayer=11]="IPlayer",e[e.IMonster=12]="IMonster",e[e.IEntityId=13]="IEntityId",e[e.IEntityMovementEngine=14]="IEntityMovementEngine",e[e.IUIRoot=15]="IUIRoot",e[e.IProjectile=16]="IProjectile",e[e.IPointLightCache=17]="IPointLightCache",e[e.IEntityMeleeAttackEngine=18]="IEntityMeleeAttackEngine",e[e.IPrimitiveCache=19]="IPrimitiveCache",e[e.IEntityDeathAnimationEngine=20]="IEntityDeathAnimationEngine",e[e.IEntityRangedAttackEngine=21]="IEntityRangedAttackEngine",e[e.IDoor=22]="IDoor",e[e.IPlayerSpellEngine=23]="IPlayerSpellEngine",e[e.IFpsDisplay=24]="IFpsDisplay",e[e.ITooltipService=25]="ITooltipService",e[e.IPlayerUseEngine=26]="IPlayerUseEngine",e[e.IPowerup=27]="IPowerup",e[e.IPlayerAuraEngine=28]="IPlayerAuraEngine",e[e.ILoadingDisplay=29]="ILoadingDisplay",e[e.IGameLoop=30]="IGameLoop"}(l||(l={}));var c,u,d=l,m=i(8),p={W:87,S:83,A:65,D:68,Up:38,Down:40,Left:37,Right:39,D1:49,D2:50,D3:51,D4:52,Enter:13,RightMouseButton:1e3,Backtick:192},v=p,g=(c={},Object(m.a)(c,p.D1,"1"),Object(m.a)(c,p.D2,"2"),Object(m.a)(c,p.D3,"3"),Object(m.a)(c,p.D4,"4"),Object(m.a)(c,p.RightMouseButton,"RMB"),c),y=window.VERSION,_=function(){function e(t){Object(s.a)(this,e),this._inputTracker=t,this._domElement=void 0,this._logItems=void 0,this._bounds=void 0,this._visible=void 0,this._keyPressed=void 0,this._logItems=[],this._bounds={},this._visible="dev-build"===y,this._keyPressed=!1,this.initDomElement()}return Object(o.a)(e,[{key:"initDomElement",value:function(){this._domElement=document.createElement("div"),this._domElement.style.color="#fff",this._domElement.style.fontFamily="Arial, Helvetica, sans-serif",this._domElement.style.fontSize="16px",this._domElement.style.position="fixed",this._domElement.style.left="10px",this._domElement.style.top="10px",this._domElement.style.zIndex="100",this._domElement.style.opacity="0.5",this._domElement.style.display="dev-build"===y?"block":"none",this._domElement.style.userSelect="none",document.body.appendChild(this._domElement)}},{key:"update",value:function(){var e=this;this.updateVisibility(),this._visible&&("dev-build"!==y&&this._logItems.unshift("isometric - build ".concat(y," - by Sergiu-Valentin Bucur"),"----"),this._domElement.innerHTML=this._logItems.join('<div style="margin-bottom: 5px"></div>'),this._logItems.length=0,Object.keys(this._bounds).forEach(function(t){var i=e._bounds[t],n=i.value,s=i.min,o=i.max,a=i.digits;e._logItems.push("".concat(t,": ").concat(n.toFixed(a)," (min: ").concat(s.toFixed(a),", max: ").concat(o.toFixed(a),")"))}))}},{key:"updateVisibility",value:function(){this._inputTracker.keysPressed[v.Backtick]||(this._keyPressed=!1),this._inputTracker.keysPressed[v.Backtick]&&!this._keyPressed&&(this.toggleVisibility(),this._keyPressed=!0)}},{key:"clear",value:function(){this._domElement.innerHTML="",this._logItems.length=0}},{key:"dispose",value:function(){document.body.removeChild(this._domElement)}},{key:"log",value:function(e){this._visible&&this._logItems.push(e)}},{key:"logNumber",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;this._visible&&this._logItems.push("".concat(e,": ").concat(t.toFixed(i)))}},{key:"logVector2",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;this._visible&&this._logItems.push("".concat(e,": ").concat(t.x.toFixed(i)," ").concat(t.y.toFixed(i)))}},{key:"logVector3",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;this._visible&&this._logItems.push("".concat(e,": ").concat(t.x.toFixed(i)," ").concat(t.y.toFixed(i)," ").concat(t.z.toFixed(i)))}},{key:"logBounds",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;if(this._visible){this._bounds[e]?(this._bounds[e].value=t,this._bounds[e].digits=i):this._bounds[e]={value:t,min:1/0,max:-1/0,digits:i};var n=this._bounds[e];n.min=Math.min(t,n.min),n.max=Math.max(t,n.max)}}},{key:"toggleVisibility",value:function(){this._visible=!this._visible,this._visible?this._domElement.style.display="block":this._domElement.style.display="none"}}]),e}(),f=i(0),k=i(15);!function(e){e[e.Map=1]="Map",e[e.Mesh=2]="Mesh",e[e.Texture=3]="Texture"}(u||(u={}));var b,x,w=u,E=[{name:"testMap",type:w.Map,filename:"test.png"},{name:"human",type:w.Mesh,filename:"human_low.glb"},{name:"metal",type:w.Texture,filename:"metal.jpg"},{name:"normalMetal",type:w.Texture,filename:"normal_metal.jpg"}],I=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,null,[{key:"disposeMesh",value:function(e){(e.geometry.dispose(),Array.isArray(e.material))?e.material.forEach(function(e){return e.dispose()}):e.material.dispose()}},{key:"disposeObject3D",value:function(t){t.traverse(function(t){"Mesh"===t.type&&e.disposeMesh(t),t.dispose&&t.dispose()})}}]),e}(),C=(b={},Object(m.a)(b,w.Map,"assets/maps/"),Object(m.a)(b,w.Mesh,"assets/meshes/"),Object(m.a)(b,w.Texture,"assets/textures/"),b),M=function(){function e(){Object(s.a)(this,e),this.assets=void 0,this._resolve=void 0,this._totalAssets=void 0,this._loadedAssets=void 0,this._totalAssets=E.length}return Object(o.a)(e,[{key:"loadAssets",value:function(){var e=this;return new Promise(function(t){e._loadedAssets=0,e.assets={},e._resolve=t,E.forEach(function(t){switch(t.type){case w.Map:e.loadMap(t);break;case w.Mesh:e.loadMesh(t);break;case w.Texture:e.loadTexture(t);break;default:throw new Error("no loader configured for this asset type")}})})}},{key:"loadMap",value:function(e){var t=this;this.assets[e.name]={},Object.assign(this.assets[e.name],e);var i=new Image;i.src=C[e.type]+e.filename,i.onload=function(){t.assets[e.name].content=i,t.onAssetLoaded()}}},{key:"loadMesh",value:function(e){var t=this;this.assets[e.name]={},Object.assign(this.assets[e.name],e),(new k.a).load(C[e.type]+e.filename,function(i){t.assets[e.name].content=i.scene.children[0],t.onAssetLoaded()})}},{key:"loadTexture",value:function(e){var t=this;this.assets[e.name]={},Object.assign(this.assets[e.name],e),(new f.Kb).load(C[e.type]+e.filename,function(i){-1===e.filename.indexOf("normal")&&(i.encoding=f.Vb),i.flipY=!0,t.assets[e.name].content=i,t.onAssetLoaded()})}},{key:"onAssetLoaded",value:function(){this._loadedAssets++,this._loadedAssets===this._totalAssets&&this._resolve(this.assets)}},{key:"dispose",value:function(){var e=this;Object.keys(this.assets).forEach(function(t){var i=e.assets[t];switch(i.type){case w.Mesh:I.disposeMesh(i.content);break;case w.Texture:i.content.dispose()}}),this.assets=null}}]),e}(),O={0:"left",1:"middle",2:"right"},P=function(){function e(){Object(s.a)(this,e),this.keysPressed=void 0,this.ctrlKey=void 0,this.altKey=void 0,this.shiftKey=void 0,this.mouseX=void 0,this.mouseY=void 0,this.leftMouseDown=void 0,this.middleMouseDown=void 0,this.rightMouseDown=void 0,this.wheelEvents=void 0,this.keysPressed={},this.ctrlKey=!1,this.altKey=!1,this.shiftKey=!1,this.mouseX=0,this.mouseY=0,this.leftMouseDown=!1,this.middleMouseDown=!1,this.rightMouseDown=!1,this.wheelEvents=[],this.init()}return Object(o.a)(e,[{key:"init",value:function(){var e=this;document.addEventListener("contextmenu",function(e){e.preventDefault()}),document.addEventListener("keydown",function(t){e.keysPressed[t.keyCode]=!0,e.ctrlKey=t.ctrlKey,e.altKey=t.altKey,e.shiftKey=t.shiftKey}),document.addEventListener("keyup",function(t){e.keysPressed[t.keyCode]=!1,e.ctrlKey=t.ctrlKey,e.altKey=t.altKey,e.shiftKey=t.shiftKey}),document.addEventListener("mousemove",function(t){e.mouseX=t.clientX,e.mouseY=t.clientY}),document.addEventListener("mousedown",function(t){e[O[t.button]+"MouseDown"]=!0}),document.addEventListener("mouseup",function(t){e[O[t.button]+"MouseDown"]=!1}),document.addEventListener("wheel",function(t){0!==t.deltaY&&e.wheelEvents.push(t.deltaY/Math.abs(t.deltaY))})}},{key:"update",value:function(){this.wheelEvents.length=0}}]),e}(),j=.1,A=1e3,S=30,T=32,F=function(){function e(){Object(s.a)(this,e),this._camera=void 0,this._position=void 0,this.zoom=void 0,this.zoom=T,this._position=new f.Pb(0,0,0),this._camera=new f.lb(S,window.innerWidth/window.innerHeight,j,A),this._camera.position.set(-this.zoom,this.zoom,this.zoom),this._camera.lookAt(0,0,0)}return Object(o.a)(e,[{key:"camera",get:function(){return this._camera}}]),Object(o.a)(e,[{key:"setPosition",value:function(e,t,i){e instanceof f.Pb?(this._camera.position.set(-this.zoom+e.x,this.zoom+e.y,this.zoom+e.z),this._position.copy(e)):(this._camera.position.set(-this.zoom+e,this.zoom+t,this.zoom+i),this._position.set(e,t,i))}},{key:"setZoom",value:function(e){this.zoom=f.P.clamp(e,12,T),this.setPosition(this._position)}}]),e}(),D=window.location.search.indexOf("half_size")>-1,L=-1===window.location.search.indexOf("no_anti_aliasing"),z=function(){function e(){Object(s.a)(this,e),this._renderer=void 0,this.init()}return Object(o.a)(e,[{key:"info",get:function(){return this._renderer.info}}]),Object(o.a)(e,[{key:"dispose",value:function(){document.body.removeChild(this._renderer.domElement),this._renderer.dispose(),this._renderer=null}},{key:"render",value:function(e,t){this._renderer.render(e,t)}},{key:"init",value:function(){var e=window.innerWidth,t=window.innerHeight;D&&(e/=2,t/=2),this._renderer=this.getRenderer(e,t),document.body.appendChild(this._renderer.domElement),D&&(this._renderer.domElement.style.width=2*e+"px",this._renderer.domElement.style.height=2*t+"px")}},{key:"getRenderer",value:function(e,t){var i=new f.Tb({antialias:L});return i.setSize(e,t),i.gammaOutput=!0,i.gammaFactor=2.2,i.toneMapping=f.vb,i}}]),e}();!function(e){e[e.Void=1]="Void",e[e.Concrete=2]="Concrete",e[e.EmptyFloor=3]="EmptyFloor",e[e.Moving=4]="Moving"}(x||(x={}));var R,N=x,U=new f.l(.5,.5,.5),H=new f.l(.35,.35,.35),B=new f.l(0,.25,.5),W=function(){function e(t){Object(s.a)(this,e),this._assetService=t,this._material=void 0,this._material={},this.initPrimitives()}return Object(o.a)(e,[{key:"buildWorldMesh",value:function(e){var t=this,i=e.edges,n=e.rectangles,s=new f.db,o=0,a=0;return n.forEach(function(e){if(e.type!==N.Void&&e.type!==N.Moving){var i=t.getFloorGeometry(e,e.type===N.Concrete?4:0),n=(new f.j).fromGeometry(i),a=e.type===N.EmptyFloor?t._material.floorConcrete:t._material.ceilingConcrete,r=new f.S(n,a);s.add(r),o++}}),i.forEach(function(e){var i=t.getWallGeometry(e),n=(new f.j).fromGeometry(i),o=t._material.wallConcrete,r=new f.S(n,o);s.add(r),a++}),console.log("floors",o),console.log("walls",a),s}},{key:"getMovingMesh",value:function(e){var t=new f.v,i=this.getFloorGeometry(e,4);t.merge(i);var n=this.getWallGeometry({x0:e.x0,y0:e.y0,x1:e.x0,y1:e.y1,type:e.type});t.merge(n);var s=this.getWallGeometry({x0:e.x0,y0:e.y1,x1:e.x1,y1:e.y1,type:e.type});t.merge(s);var o=(new f.j).fromGeometry(t);return new f.S(o,this._material.movingConcrete)}},{key:"getFloorGeometry",value:function(e,t){var i=new f.v,n=e.x0,s=e.y0,o=e.x1,a=e.y1;return i.vertices.push(new f.Pb(n-.5,t,s-.5)),i.vertices.push(new f.Pb(o-.5,t,s-.5)),i.vertices.push(new f.Pb(o-.5,t,a-.5)),i.vertices.push(new f.Pb(n-.5,t,s-.5)),i.vertices.push(new f.Pb(o-.5,t,a-.5)),i.vertices.push(new f.Pb(n-.5,t,a-.5)),i.faces.push(new f.s(2,1,0)),i.faces.push(new f.s(5,4,3)),i.faceVertexUvs=[[]],i.faceVertexUvs[0].push([new f.Ob(o/16,a/16),new f.Ob(o/16,s/16),new f.Ob(n/16,s/16)]),i.faceVertexUvs[0].push([new f.Ob(n/16,a/16),new f.Ob(o/16,a/16),new f.Ob(n/16,s/16)]),i.computeVertexNormals(),i}},{key:"getWallGeometry",value:function(e){var t=new f.v,i=e.x0,n=e.y0,s=e.x1,o=e.y1,a=new f.Ob(i,n).distanceTo(new f.Ob(s,o))/16;return t.vertices.push(new f.Pb(i-.5,0,n-.5)),t.vertices.push(new f.Pb(i-.5,4,n-.5)),t.vertices.push(new f.Pb(s-.5,0,o-.5)),t.vertices.push(new f.Pb(i-.5,4,n-.5)),t.vertices.push(new f.Pb(s-.5,4,o-.5)),t.vertices.push(new f.Pb(s-.5,0,o-.5)),t.faces.push(new f.s(2,1,0)),t.faces.push(new f.s(5,4,3)),t.faceVertexUvs=[[]],t.faceVertexUvs[0].push([new f.Ob(0,a),new f.Ob(.25,0),new f.Ob(0,0)]),t.faceVertexUvs[0].push([new f.Ob(0,a),new f.Ob(.25,a),new f.Ob(.25,0)]),t.computeVertexNormals(),t}},{key:"initPrimitives",value:function(){this._material.floorConcrete=this.getMaterial("metal","normalMetal",U),this._material.ceilingConcrete=this.getMaterial("metal","normalMetal",H),this._material.wallConcrete=this.getMaterial("metal","normalMetal",H),this._material.movingConcrete=this.getMaterial("metal","normalMetal",B)}},{key:"getMaterial",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new f.l(1,1,1),n=new f.U({color:i});return n.map=this._assetService.assets[e].content,n.map.wrapS=f.wb,n.map.wrapT=f.wb,n.normalMap=this._assetService.assets[t].content,n.normalMap.wrapS=f.wb,n.normalMap.wrapT=f.wb,n}},{key:"dispose",value:function(){var e=this;Object.keys(this._material).forEach(function(t){e._material[t].dispose()}),this._material=null}}]),e}();!function(e){e[e.Physical=1]="Physical",e[e.Powerup=2]="Powerup"}(R||(R={}));var V=R,K=function(){function e(t,i){var n;Object(s.a)(this,e),this.size=void 0,this.cells=void 0,this.matrices=void 0,this.size=t,this.cells=i,this.matrices=(n={},Object(m.a)(n,V.Physical,this.getCellMatrix()),Object(m.a)(n,V.Powerup,this.getCellMatrix()),n)}return Object(o.a)(e,[{key:"getCellMatrix",value:function(){return new Uint32Array(this.size*this.size)}},{key:"convertToMapPosition",value:function(e){var t=e.clone();return t.x=Math.round(t.x),t.z=Math.round(t.z),t}},{key:"getCell",value:function(e,t){return e>=0&&e<this.size&&t>=0&&t<this.size?this.cells[t*this.size+e]:null}},{key:"isCellPassable",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=this.getCell(e,t);if(!n)return!1;var s=this.getMatrix(V.Physical)[t*this.size+e];return!(0!==s&&-1===i.indexOf(s))&&(n===N.EmptyFloor||n===N.Moving)}},{key:"areaIsPassable",value:function(e,t,i){for(var n=t-i;n<t+i;n++)for(var s=e-i;s<e+i;s++)if(!this.isCellPassable(s,n))return!1;return!0}},{key:"getAllEntityIdsInArea",value:function(e,t,i){for(var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:V.Physical,s=[],o=this.getMatrix(n),a=t-i;a<t+i;a++)for(var r=e-i;r<e+i;r++){if(this.getCell(r,a)){var l=o[a*this.size+r];l>0&&-1===s.indexOf(l)&&s.push(l)}}return s}},{key:"getEntityIdAt",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.Physical;return this.getCell(e,t)?this.getMatrix(i)[t*this.size+e]:null}},{key:"occupyCell",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:V.Physical;this.getMatrix(n)[t*this.size+e]=i}},{key:"vacateCell",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:V.Physical;this.getMatrix(i)[t*this.size+e]=0}},{key:"getMatrix",value:function(e){return this.matrices[e]}}]),e}();function q(e,t){e.sort(function(e,i){return(e.y-i.y)*t+e.x-i.x})}function Y(e,t,i,n){return i>=0&&i<t&&n>=0&&n<t?e[n*t+i]:null}var G,X,Z=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"extract",value:function(e,t){for(var i=[],n=0;n<t;n++)for(var s=0;s<t;s++){var o=Y(e,t,s,n-1),a=Y(e,t,s-1,n),r=Y(e,t,s,n),l=Y(e,t,s+1,n),h=Y(e,t,s,n+1),c=Y(e,t,s+1,n+1);o!==r&&a!==r&&i.push({x:s,y:n,type:r}),l&&l!==r&&o!==r&&i.push({x:s+1,y:n,type:l}),c&&h!==r&&l!==r&&i.push({x:s+1,y:n+1,type:c}),h&&h!==r&&a!==r&&i.push({x:s,y:n+1,type:h})}return i}}]),e}(),J=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"extract",value:function(e,t,i){for(var n=[];;){var s=i.find(function(e){return!e.expanded});if(!s)break;var o=this.getBottomRightCorner(i,t,s),a={x0:s.x,x1:o.x+1,y0:s.y,y1:o.y+1,type:s.type};n.push(a),this.tryAddCorner(i,e,t,a.x1,a.y0),this.tryAddCorner(i,e,t,a.x1,a.y1),this.tryAddCorner(i,e,t,a.x0,a.y1),q(i,t),s.expanded=!0}return n}},{key:"tryAddCorner",value:function(e,t,i,n,s){var o=Y(t,i,n,s);o&&!e.find(function(e){return e.x===n&&e.y===s})&&e.push({x:n,y:s,type:o})}},{key:"getBottomRightCorner",value:function(e,t,i){var n=e.find(function(e){return e.x>i.x&&e.y===i.y}),s=n?n.x-1:t-1,o=e.find(function(e){return e.y>i.y});return{x:s,y:o?o.y-1:t-1}}}]),e}(),Q={"0,0,0":N.Void,"64,64,64":N.Concrete,"255,255,255":N.EmptyFloor,"0,128,255":N.Moving},$=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"extract",value:function(e){for(var t=this.getImageData(e),i=e.width,n=new Uint8ClampedArray(i*i),s=0;s<i;s++)for(var o=0;o<i;o++){var a,r=4*(s*i+o),l="".concat(t[r],",").concat(t[r+1],",").concat(t[r+2]);if(!Q[l])throw new Error("undefined cell type");a=Q[l],n[s*i+o]=a}return{cells:n,size:i}}},{key:"getImageData",value:function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");return i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height).data}}]),e}(),ee=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"filter",value:function(e){this.removeDuplicateRectangles(e),this.mergeAdjacentMovingRectangles(e)}},{key:"removeDuplicateRectangles",value:function(e){for(var t=0,i=function(){var i=e[t];e.find(function(e){return i!==e&&i.x0===e.x0&&i.y0===e.y0&&i.x1===e.x1&&i.y1===e.y1})?e.splice(t,1):t++};t<e.length;)i()}},{key:"mergeAdjacentMovingRectangles",value:function(e){for(var t=this,i={x0:0,y0:0,x1:0,y1:0,type:N.Void},n=function(n){var s=e[n];if(s.type!==N.Moving)return"continue";var o=e.findIndex(function(e){return s!==e&&s.type===e.type&&t.canMergeRectangles(s,e,i)});o>-1&&(t.rectangleCopy(s,i),e.splice(o,1))},s=0;s<e.length;s++)n(s)}},{key:"canMergeRectangles",value:function(e,t,i){var n=this.getRectangleEdges(e),s=this.getRectangleEdges(t);return this.edgeEqualsReverse(n[0],s[2])||this.edgeEqualsReverse(n[3],s[1])?(i.x0=t.x0,i.y0=t.y0,i.x1=e.x1,i.y1=e.y1,i.type=e.type,!0):!(!this.edgeEqualsReverse(n[1],s[3])&&!this.edgeEqualsReverse(n[2],s[0]))&&(i.x0=e.x0,i.y0=e.y0,i.x1=t.x1,i.y1=t.y1,i.type=e.type,!0)}},{key:"rectangleCopy",value:function(e,t){e.x0=t.x0,e.y0=t.y0,e.x1=t.x1,e.y1=t.y1,e.type=t.type}},{key:"getRectangleEdges",value:function(e){var t=[];return t.push({x0:e.x0,y0:e.y0,x1:e.x1,y1:e.y0,type:e.type}),t.push({x0:e.x1,y0:e.y0,x1:e.x1,y1:e.y1,type:e.type}),t.push({x0:e.x1,y0:e.y1,x1:e.x0,y1:e.y1,type:e.type}),t.push({x0:e.x0,y0:e.y1,x1:e.x0,y1:e.y0,type:e.type}),t}},{key:"edgeEqualsReverse",value:function(e,t){return e.x0===t.x1&&e.y0===t.y1&&e.x1===t.x0&&e.y1===t.y0}}]),e}(),te=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"extract",value:function(e,t){var i=this,n=[];return e.forEach(function(e){i.addEdge(e.x0,e.y0,e.x1,e.y0,e.type,n),i.addEdge(e.x1,e.y0,e.x1,e.y1,e.type,n),i.addEdge(e.x1,e.y1,e.x0,e.y1,e.type,n),i.addEdge(e.x0,e.y1,e.x0,e.y0,e.type,n)}),n=this.splitIntersectingEdges(n),n=this.reduceToCommonEdges(n),t&&(n=this.removeOccludedEdges(n,e)),n}},{key:"edgeVerticesEquals",value:function(e,t){return e.x0===t.x0&&e.y0===t.y0&&e.x1===t.x1&&e.y1===t.y1||e.x0===t.x1&&e.y0===t.y1&&e.x1===t.x0&&e.y1===t.y0}},{key:"reduceToCommonEdges",value:function(e){for(var t=this,i=[],n=0;n<e.length;n++)for(var s=e[n],o=function(o){if(n===o)return"continue";var a=e[o];if(s.type!==a.type&&t.edgeVerticesEquals(s,a))if(s.type===N.Concrete){var r=i.findIndex(function(e){return t.edgeVerticesEquals(e,a)});r>-1&&i.splice(r,1),i.push(s)}else s.type===N.EmptyFloor&&(i.find(function(e){return t.edgeVerticesEquals(e,a)})||i.push(s))},a=0;a<e.length;a++)o(a);return i}},{key:"splitIntersectingEdges",value:function(e){for(var t=[],i=[],n=0;n<e.length;n++){for(var s=e[n],o=[],a=function(t){if(n===t)return"continue";var i=e[t];return i.x1<s.x0||i.x0>s.x1||i.y1<s.y0||i.y0>s.y1?"continue":s.x0===s.x1&&i.x0===i.x1||s.y0===s.y1&&i.y0===i.y1?"continue":s.x0===i.x0&&s.y0===i.y0||s.x1===i.x1&&s.y1===i.y1||s.x1===i.x0&&s.y1===i.y0||s.x0===i.x1&&s.y0===i.y1?"continue":void((s.x0<i.x0&&i.x0<s.x1||s.y0<i.y0&&i.y0<s.y1)&&(o.find(function(e){return e.x===i.x0&&e.y===i.y0})||o.push({x:i.x0,y:i.y0})))},r=0;r<e.length;r++)a(r);if(o.length>0&&(i.push(s),s.x0<s.x1)){o.sort(function(e,t){return e.x-t.x});for(var l={x:s.x0,y:s.y0},h=void 0,c=0;c<o.length;c++)h=o[c],this.addEdge(l.x,l.y,h.x,h.y,s.type,t),l=h;this.addEdge(h.x,h.y,s.x1,s.y1,s.type,t)}}var u=e.filter(function(e){return!i.find(function(t){return t===e})});return u.push.apply(u,t),u}},{key:"edgeEqualsReverseDirection",value:function(e,t){return e.type===t.type&&e.x0===t.x1&&e.y0===t.y1&&e.x1===t.x0&&e.y1===t.y0}},{key:"removeOccludedEdges",value:function(e,t){var i=this,n=[];return e.forEach(function(e){if(e.type===N.Concrete)for(var s=0;s<t.length;s++){var o=t[s];if(i.edgeEqualsReverseDirection(e,i.constructEdge(o.x1,o.y1,o.x0,o.y1,o.type))||i.edgeEqualsReverseDirection(e,i.constructEdge(o.x0,o.y1,o.x0,o.y0,o.type))){n.push(e);break}}}),e.filter(function(e){return e.type!==N.Concrete||n.find(function(t){return t===e})})}},{key:"constructEdge",value:function(e,t,i,n,s){return{x0:e,y0:t,x1:i,y1:n,type:s}}},{key:"addEdge",value:function(e,t,i,n,s,o){o.push(this.ensureEdgeDirection({x0:e,y0:t,x1:i,y1:n,type:s}))}},{key:"ensureEdgeDirection",value:function(e){if(e.x0>e.x1){var t=e.x0;e.x0=e.x1,e.x1=t}if(e.y0>e.y1){var i=e.y0;e.y0=e.y1,e.y1=i}return e}}]),e}(),ie=(G={},Object(m.a)(G,N.Void,{r:64,g:0,b:0,a:255}),Object(m.a)(G,N.Concrete,{r:128,g:0,b:0,a:255}),Object(m.a)(G,N.EmptyFloor,{r:192,g:0,b:0,a:255}),Object(m.a)(G,N.Moving,{r:0,g:128,b:255,a:255}),G),ne=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"draw",value:function(e){var t=this,i=e.size,n=this.getCanvas(e.cells,i);document.body.appendChild(n);var s=n.getContext("2d",{alpha:!1}),o=s.getImageData(0,0,i,i);e.drawCorners&&this.drawCorners(s,o,i,e.corners),e.drawRectangles?this.drawRectangles(s,o,i,e.rectangles,e.delay).then(function(){t.drawEdges&&t.drawEdges(s,o,i,e.edges,e.delay)}):e.drawEdges&&this.drawEdges(s,o,i,e.edges,e.delay)}},{key:"drawCorners",value:function(e,t,i,n){var s=this;n.forEach(function(e){s.putPixel(t.data,i,e.x,e.y,0,255,0,255)}),e.putImageData(t,0,0)}},{key:"drawRectangles",value:function(e,t,i,n){var s=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return new Promise(function(a){!function r(l){l>=n.length?a():(s.drawRectangle(t.data,i,n[l]),e.putImageData(t,0,0),setTimeout(function(){return r(l+1)},o))}(0)})}},{key:"drawEdges",value:function(e,t,i,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return new Promise(function(t){!function i(o){if(o>=n.length)t();else{var a=n[o];a.type===N.Concrete?e.strokeStyle="#ff0000":e.strokeStyle="#0080ff",e.beginPath(),e.moveTo(a.x0,a.y0),e.lineTo(a.x1,a.y1),e.stroke(),setTimeout(function(){return i(o+1)},s)}}(0)})}},{key:"getCanvas",value:function(e,t){var i=document.createElement("canvas");return i.width=t,i.height=t,i.style.imageRendering="pixelated",i.style.width="".concat(3*t,"px"),i.style.height="".concat(3*t,"px"),i.style.border="1px solid #404040",i.style.margin="8px",i.style.zIndex="100",i.style.position="absolute",i.style.left="0",i.style.top="0",this.drawCells(i,e,t),i}},{key:"drawCells",value:function(e,t,i){for(var n=e.getContext("2d",{alpha:!1}),s=n.getImageData(0,0,i,i),o=s.data,a=0;a<i;a++)for(var r=0;r<i;r++){switch(t[a*i+r]){case N.Void:this.putPixel(o,i,r,a,0,0,0,255);break;case N.Concrete:this.putPixel(o,i,r,a,64,64,64,255);break;case N.EmptyFloor:this.putPixel(o,i,r,a,255,255,255,255)}}n.putImageData(s,0,0)}},{key:"putPixel",value:function(e,t,i,n,s,o,a,r){var l=4*(n*t+i);e[l]=s,e[l+1]=o,e[l+2]=a,e[l+3]=r}},{key:"drawRectangle",value:function(e,t,i){for(var n=ie[i.type],s=i.y0;s<i.y1;s++)for(var o=i.x0;o<i.x1;o++)o>i.x0&&o<i.x1-1&&s>i.y0&&s<i.y1-1||this.putPixel(e,t,o,s,n.r,n.g,n.b,n.a)}}]),e}(),se=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"loadMap",value:function(e){var t=(new $).extract(e),i=t.cells,n=t.size,s=this.getPrimitives(i,n),o=(s.corners,s.rectangles),a=s.edges;return{map:new K(n,i),rectangles:o,edges:a}}},{key:"drawResult",value:function(e,t,i,n,s){(new ne).draw({drawCorners:!1,drawRectangles:!1,drawEdges:!0,delay:0,cells:e,size:t,corners:i,rectangles:n,edges:s})}},{key:"getPrimitives",value:function(e,t){var i=(new Z).extract(e,t);q(i,t);var s=(new J).extract(e,t,Object(n.a)(i));this.maskRectangles(s);var o=(new te).extract(s,!0);return this.unmaskRectangles(s),(new ee).filter(s),{corners:i,rectangles:s,edges:o}}},{key:"maskRectangles",value:function(e){e.forEach(function(e){e.type===N.Moving&&(e.type=N.EmptyFloor,e.originalType=N.Moving)})}},{key:"unmaskRectangles",value:function(e){e.forEach(function(e){e.originalType&&(e.type=e.originalType,e.originalType=void 0)})}}]),e}(),oe=function(){function e(t,i,n,o,a,r,l,h,c,u){Object(s.a)(this,e),this._assetService=t,this._mapLoader=i,this._worldMeshBuilder=n,this._monsterFactory=o,this._projectileFactory=a,this._logger=r,this._pointLightCacheFactory=l,this._primitiveCache=h,this._doorFactory=c,this._powerupFactory=u,this.scene=void 0,this.map=void 0,this._monsters=void 0,this._projectiles=void 0,this._doors=void 0,this._powerups=void 0,this._player=void 0,this._pointLightCache=void 0,this.scene=new f.yb,this._monsters=[],this._projectiles=[],this._doors=[],this._powerups=[],this._player=null}return Object(o.a)(e,[{key:"totalMonsters",get:function(){return this._monsters.length}}]),Object(o.a)(e,[{key:"init",value:function(){this.initMap(),this.initLights()}},{key:"setPlayer",value:function(e){this._player=e}},{key:"update",value:function(){this._doors.forEach(function(e){return e.update()}),this._monsters.forEach(function(e){return e.update()}),this._projectiles.forEach(function(e){e.toBeDeleted||e.update()}),this._powerups.forEach(function(e){e.toBeDeleted||e.update()}),this._player.update(),this.deleteMarkedEntities();var e=this._monsters.length+this._projectiles.length+this._doors.length+this._powerups.length+1;this._logger.logNumber("map entities",e,0)}},{key:"deleteMarkedEntities",value:function(){this._projectiles.filter(function(e){return e.toBeDeleted}).forEach(function(e){return e.dispose()}),this._projectiles=this._projectiles.filter(function(e){return!e.toBeDeleted});var e=this._powerups.filter(function(e){return e.toBeDeleted});e.length>0&&(e.forEach(function(e){return e.dispose()}),this._powerups=this._powerups.filter(function(e){return!e.toBeDeleted}),this._powerups.forEach(function(e){return e.occupyMapCells()}))}},{key:"addMesh",value:function(e){this.scene.add(e)}},{key:"removeMesh",value:function(e){this.scene.remove(e)}},{key:"areaDamage",value:function(e,t,i){var n=this,s=this.map.convertToMapPosition(e),o=this.map.getAllEntityIdsInArea(s.x,s.z,t);i===this._player.id?o.forEach(function(e){var t=n._monsters.find(function(t){return t.id===e});t&&t.id!==i&&t.damage()}):o.indexOf(this._player.id)>-1&&this._player.damage()}},{key:"addProjectile",value:function(e){var t=this._projectileFactory();t.init(e),this._projectiles.push(t)}},{key:"addPowerup",value:function(e,t){var i=this._powerupFactory();i.init(t,e),this._powerups.push(i)}},{key:"initEntities",value:function(){this.initMonsters()}},{key:"initMonsters",value:function(){for(var e=0;e<this.map.size;e++)for(var t=0;t<this.map.size;t++)t<64&&e<64||this.map.areaIsPassable(t,e,3)&&Math.random()<.0025&&this.addMonster(new f.Pb(t,0,e))}},{key:"getEntityAtPosition",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?this.map.convertToMapPosition(e):e,i=this.map.getEntityIdAt(t.x,t.z),n=this._monsters.find(function(e){return e.id===i});if(n)return n;var s=this._doors.find(function(e){return e.id===i});return s||null}},{key:"getPowerupsInArea",value:function(e,t){var i=this.map.convertToMapPosition(e),n=this.map.getAllEntityIdsInArea(i.x,i.z,t,V.Powerup);return this._powerups.filter(function(e){return!e.toBeDeleted&&n.find(function(t){return t===e.id})})}},{key:"initMap",value:function(){var e=this,t=this._mapLoader.loadMap(this._assetService.assets.testMap.content);this.map=t.map;var i=this._worldMeshBuilder.buildWorldMesh(t);this.scene.add(i),t.rectangles.filter(function(e){return e.type===N.Moving}).forEach(function(t){var i=e._doorFactory();i.init(t,e._worldMeshBuilder.getMovingMesh(t)),e._doors.push(i)}),console.log("doors",this._doors.length)}},{key:"initLights",value:function(){var e=new f.c(new f.l(.001,.001,.001));this.scene.add(e);var t=new f.n(new f.l(.01,.01,.01));t.position.set(-.25,.5,-.75).normalize(),this.scene.add(t),this._pointLightCache=this._pointLightCacheFactory()}},{key:"addMonster",value:function(e){var t=this._monsterFactory();t.init(e),this._monsters.push(t)}},{key:"dispose",value:function(){this._primitiveCache.dispose(),this._worldMeshBuilder.dispose(),I.disposeObject3D(this.scene),this.scene.dispose()}}]),e}(),ae=function(){function e(t,i,n,o){Object(s.a)(this,e),this._camera=t,this._inputTracker=i,this._world=n,this._logger=o,this.mousePosition=void 0,this.mapPosition=void 0,this.onLeftClick=void 0,this.onRightClick=void 0,this._pointerMesh=void 0,this._plane=void 0,this.mousePosition=new f.Pb,this.mapPosition=new f.Pb,this.onLeftClick=function(){},this.onRightClick=function(){},this._plane=new f.mb(new f.Pb(0,1,0)),this.initPointerMesh()}return Object(o.a)(e,[{key:"update",value:function(){this.updateMousePosition(),this.updateZoomLevel()}},{key:"show",value:function(){this._pointerMesh.visible=!0}},{key:"hide",value:function(){this._pointerMesh.visible=!1}},{key:"updateMousePosition",value:function(){var e=this._inputTracker.mouseX/window.innerWidth*2-1,t=-this._inputTracker.mouseY/window.innerHeight*2+1,i=new f.ub;i.setFromCamera({x:e,y:t},this._camera.camera),this.mousePosition=new f.Pb,i.ray.intersectPlane(this._plane,this.mousePosition),this.mapPosition=this._world.map.convertToMapPosition(this.mousePosition),this._inputTracker.leftMouseDown&&this.onLeftClick(),this._inputTracker.rightMouseDown&&this.onRightClick(),this._pointerMesh.position.set(this.mapPosition.x,.05,this.mapPosition.z)}},{key:"updateZoomLevel",value:function(){var e=this._inputTracker.wheelEvents.reduce(function(e,t){return e+t},0);0!==e&&this._camera.setZoom(this._camera.zoom+2*e)}},{key:"initPointerMesh",value:function(){var e=new f.h,t=new f.U({color:12245589});t.emissive.set(12245589),t.emissiveIntensity=1,t.opacity=.5,t.transparent=!0,this._pointerMesh=new f.S(e,t),this._pointerMesh.scale.set(1,.1,1),this._world.addMesh(this._pointerMesh)}}]),e}();!function(e){e[e.Cloaked=1]="Cloaked",e[e.Energized=2]="Energized"}(X||(X={}));var re,le=X,he=new f.Pb(16,0,16),ce=2,ue=100,de=100,me=.1,pe=1e4,ve=function(){function e(t,i,n,o,a,r,l,h,c,u,d,m){var p=this;Object(s.a)(this,e),this._mouseControls=t,this._camera=i,this._inputTracker=n,this._world=o,this._logger=a,this._entityId=r,this._movementEngine=l,this._assetService=h,this._deathAnimationEngine=c,this._spellEngine=u,this._useEngine=d,this.id=void 0,this.invisible=void 0,this.size=void 0,this.dead=void 0,this.health=void 0,this.totalHealth=void 0,this.mana=void 0,this.totalMana=void 0,this.manaRegen=void 0,this.mouseOverTarget=void 0,this.experience=void 0,this.experienceToNextLevel=void 0,this.auraEngine=void 0,this._mesh=void 0,this._pointLight=void 0,this._mouseControls.onLeftClick=function(){return p.handleLeftClick()},this.id=this._entityId.getNewId(),this.size=ce,this.dead=!1,this.totalHealth=ue,this.health=this.totalHealth,this.totalMana=de,this.mana=this.totalMana,this.manaRegen=me,this.mouseOverTarget=null,this.experience=0,this.experienceToNextLevel=pe,this.auraEngine=m,this.initMovementEngine(),this._camera.setPosition(he),this.initMesh(),this.initOtherEngines()}return Object(o.a)(e,[{key:"position",get:function(){return this._movementEngine.position}},{key:"spellEngine",get:function(){return this._spellEngine}}]),Object(o.a)(e,[{key:"initMovementEngine",value:function(){var e=this;this._movementEngine.init(this.id,he,ce,.25),this._movementEngine.afterPositionUpdate=function(){e._camera.setPosition(e._movementEngine.position),e.updateMeshPosition(),e._useEngine.afterPositionUpdate(),e.absorbPowerups()}}},{key:"initOtherEngines",value:function(){this._deathAnimationEngine.init(this._mesh,this.size),this._spellEngine.init(this,this._movementEngine,this._mouseControls),this._useEngine.init(this._movementEngine),this.auraEngine.init(this)}},{key:"update",value:function(){if(this.dead)return this._deathAnimationEngine.runAnimation(),void(this._inputTracker.keysPressed[v.Enter]&&this.resurrect());this.auraEngine.update(),this.updateManaRegen(),this._mouseControls.update(),this.updateMouseOverTarget(),this._movementEngine.move(),this._spellEngine.update()}},{key:"updateMouseOverTarget",value:function(){this.mouseOverTarget=this._world.getEntityAtPosition(this._mouseControls.mapPosition,!1),this._useEngine.afterMouseOverTargetUpdate(this.mouseOverTarget)}},{key:"damage",value:function(){this.dead||(this.setInvisibility(!1),this.health-=25,this.health<=0&&(this.health=0,this.die()))}},{key:"updateManaRegen",value:function(){this.mana+=this.manaRegen,this.mana=f.P.clamp(this.mana,0,this.totalMana)}},{key:"die",value:function(){this.experience=Math.floor(.75*this.experience),this.setInvisibility(!1),this._pointLight.color.setHex(16711680),this.updateMeshPosition(),this._deathAnimationEngine.startAnimation(),this._movementEngine.clearCells(),this._movementEngine.stop(),this._mouseControls.hide(),this.dead=!0}},{key:"resurrect",value:function(){this.auraEngine.clearAuras(),this._pointLight.color.setHex(16767154),this._deathAnimationEngine.cancelAnimation(),this._mouseControls.show(),this._movementEngine.moveTo(he),this.health=this.totalHealth,this.mana=this.totalMana,this.dead=!1}},{key:"handleLeftClick",value:function(){this._useEngine.onLeftClick(this.mouseOverTarget),this._movementEngine.startMovingTo(this._mouseControls.mousePosition)}},{key:"setInvisibility",value:function(e){e?this.auraEngine.addAura(le.Cloaked):this.auraEngine.removeAura(le.Cloaked),this._mesh.material.opacity=e?.33:1}},{key:"spendMana",value:function(e){this.mana-=e}},{key:"absorbPowerups",value:function(){var e=this;this._world.getPowerupsInArea(this._movementEngine.position,this.size).forEach(function(t){e.auraEngine.addAura(le.Energized),t.markForDeletion()})}},{key:"initMesh",value:function(){var e=this._assetService.assets.human.content.geometry,t=new f.U({color:16767154});t.transparent=!0,t.opacity=1,this._mesh=new f.S(e,t),this._mesh.scale.set(ce,ce,ce),this._mesh.rotation.order="ZYX",this._pointLight=new f.nb(16767154,3,20),this._pointLight.position.set(0,4,0),this._mesh.add(this._pointLight),this.updateMeshPosition(),this._world.addMesh(this._mesh)}},{key:"updateMeshPosition",value:function(){this._mesh.position.copy(this._movementEngine.position),this._mesh.rotation.y=this._movementEngine.rotationY}},{key:"gainExperience",value:function(){this.experience+=Math.floor(pe/this._world.totalMonsters),this.experience=f.P.clamp(this.experience,0,pe)}},{key:"gainHealth",value:function(e){this.health+=e,this.health=f.P.clamp(this.health,0,this.totalHealth)}},{key:"gainMana",value:function(e){this.mana+=e,this.mana=f.P.clamp(this.mana,0,this.totalMana)}}]),e}();!function(e){e[e.None=1]="None",e[e.Load=2]="Load",e[e.Init=3]="Init",e[e.Run=4]="Run",e[e.Restart=5]="Restart"}(re||(re={}));var ge,ye=re,_e=function(){function e(t,i,n,o,a,r,l,h,c,u,d){var m=this;Object(s.a)(this,e),this._logger=t,this._assetServiceFactory=i,this._inputTracker=n,this._cameraFactory=o,this._rendererFactory=a,this._worldFactory=r,this._playerFactory=l,this._uiRootFactory=h,this._fpsDisplay=c,this._loadingDisplay=u,this._gameLoop=d,this.onRestart=void 0,this._state=void 0,this._nextState=void 0,this._camera=void 0,this._world=void 0,this._renderer=void 0,this._uiRoot=void 0,this._assetService=void 0,this.onRestart=function(){},this._state=ye.None,this._nextState=null,this._camera=null,this._world=null,this._renderer=null,this._assetService=null,this._gameLoop.onUpdate=function(){return m.update()},this._gameLoop.onDraw=function(){return m.draw()},this._gameLoop.afterFrame=function(){return m._fpsDisplay.afterFrame()},this._gameLoop.run(),this._nextState=ye.Load}return Object(o.a)(e,[{key:"update",value:function(){switch(this.handleStateChange(),this._state){case ye.Run:var e=performance.now();this._world.update(),this._logger.logNumber("update time",performance.now()-e),this._inputTracker.keysPressed[v.D4]&&this._inputTracker.altKey&&this._inputTracker.shiftKey&&(this._nextState=ye.Restart)}this._logger.update(),this._inputTracker.update()}},{key:"draw",value:function(){switch(this._state){case ye.Run:var e=performance.now();this._renderer.render(this._world.scene,this._camera.camera),this._logger.logNumber("draw time",performance.now()-e),this._logger.logNumber("info.memory.geometries",this._renderer.info.memory.geometries,0),this._logger.logNumber("info.memory.textures",this._renderer.info.memory.textures,0),this._logger.logNumber("info.memory.programs",this._renderer.info.programs.length,0),this._logger.logNumber("info.render.calls",this._renderer.info.render.calls,0),this._logger.logNumber("info.render.triangles",this._renderer.info.render.triangles,0)}}},{key:"handleStateChange",value:function(){var e=this;if(this._nextState)return this._logger.clear(),this._fpsDisplay.hide(),this._loadingDisplay.hide(),this._nextState===ye.Load?(this._loadingDisplay.show(),this.load(),this._state=this._nextState,void(this._nextState=null)):this._nextState===ye.Init?(this._loadingDisplay.show(),setTimeout(function(){return e.init()}),this._state=this._nextState,void(this._nextState=null)):this._nextState===ye.Run?(this._fpsDisplay.show(),this._state=this._nextState,void(this._nextState=null)):this._nextState===ye.Restart?(this._loadingDisplay.show(),setTimeout(function(){return e.restart()}),this._state=this._nextState,void(this._nextState=null)):void 0}},{key:"load",value:function(){var e=this;this._assetService=this._assetServiceFactory(),this._assetService.loadAssets().then(function(){e._nextState=ye.Init})}},{key:"init",value:function(){this._camera=this._cameraFactory(),this._renderer=this._rendererFactory(),this._world=this._worldFactory(),this._world.init();var e=this._playerFactory();this._world.setPlayer(e),this._world.initEntities(),-1===window.location.search.indexOf("disable_ui")&&(this._uiRoot=this._uiRootFactory()),this._nextState=ye.Run}},{key:"restart",value:function(){this.onRestart(),this._uiRoot&&this._uiRoot.dispose(),this._uiRoot=null,this._camera=null,this._renderer.dispose(),this._renderer=null,this._world.dispose(),this._world=null,this._assetService.dispose(),this._assetService=null,this._nextState=ye.Load}}]),e}();!function(e){e[e.Energy=1]="Energy"}(ge||(ge={}));var fe=ge,ke=2,be=16711680,xe=33023,we="MonsterMelee",Ee="MonsterRanged",Ie=function(){function e(t,i,n,o,a,r,l,h,c){Object(s.a)(this,e),this._world=t,this._player=i,this._entityId=n,this._movementEngine=o,this._assetService=a,this._meleeAttackEngineFactory=r,this._rangedAttackEngineFactory=l,this._primitiveCache=h,this._deathAnimationEngine=c,this.id=void 0,this.dead=void 0,this.size=void 0,this._mesh=void 0,this._scatterFrames=void 0,this._material=void 0,this._attackEngine=void 0,this._ranged=void 0,this.id=this._entityId.getNewId(),this.dead=!1,this.size=ke,this._ranged=Math.random()>.5,this._scatterFrames=0,this._material=this._ranged?this._primitiveCache.getMaterial(Ee,function(){return new f.U({color:xe})}):this._primitiveCache.getMaterial(we,function(){return new f.U({color:be})})}return Object(o.a)(e,[{key:"init",value:function(e){var t=this;this._movementEngine.init(this.id,e,ke,this._ranged?.05:.1),this._movementEngine.afterPositionUpdate=function(){t.updateMeshPosition()},this.initMesh(),this.initAttackEngine(),this._deathAnimationEngine.init(this._mesh,this.size)}},{key:"initAttackEngine",value:function(){var e=this;if(this._ranged){var t=this._rangedAttackEngineFactory();return t.init(function(){return e._player.position},function(){return!e._player.auraEngine.hasAura(le.Cloaked)},30,this._mesh,this._movementEngine),t.onHit=function(){e.throwProjectile()},void(this._attackEngine=t)}var i=this._meleeAttackEngineFactory();i.init(function(){return e._player.position},function(){return e._player.size},this._mesh,this._movementEngine,this.size),i.onHit=function(){e._player.damage()},this._attackEngine=i}},{key:"update",value:function(){this.dead?this._deathAnimationEngine.runAnimation():(this._attackEngine.update(),this._attackEngine.isAttacking()?this._attackEngine.performAttack():!this._player.dead&&this._attackEngine.canAttack()?this._attackEngine.startAttacking():(this._scatterFrames>0?this._scatterFrames--:(this.chase(),Math.random()<.01&&this.scatter()),this._movementEngine.move()))}},{key:"damage",value:function(){this.dead||(this.dropPowerup(),this._player.gainExperience(),this.updateMeshPosition(),this._deathAnimationEngine.startAnimation(),this._movementEngine.clearCells(),this._movementEngine.stop(),this.dead=!0)}},{key:"dropPowerup",value:function(){var e=this._world.map.convertToMapPosition(this._movementEngine.position);this._world.addPowerup(e,fe.Energy)}},{key:"throwProjectile",value:function(){this._world.addProjectile({startPosition:this._movementEngine.position,targetPosition:this._player.position,speed:.33,color:new f.l(33023),originEntityId:this.id,splashRadius:3})}},{key:"chase",value:function(){this._player.dead||this._player.auraEngine.hasAura(le.Cloaked)||this._movementEngine.startMovingTo(this._player.position)}},{key:"scatter",value:function(){var e=this._movementEngine.position.clone();e.x+=10*Math.random()*2-10,e.z+=10*Math.random()*2-10,this._movementEngine.startMovingTo(e),this._scatterFrames=60}},{key:"initMesh",value:function(){var e=this._assetService.assets.human.content.geometry;this._mesh=new f.S(e,this._material),this._mesh.scale.set(ke,ke,ke),this._mesh.rotation.order="ZYX",this.updateMeshPosition(),this._world.addMesh(this._mesh)}},{key:"updateMeshPosition",value:function(){this._mesh.position.copy(this._movementEngine.position),this._mesh.rotation.y=this._movementEngine.rotationY}}]),e}(),Ce=function(){function e(){Object(s.a)(this,e),this._id=void 0,this._id=0}return Object(o.a)(e,[{key:"getNewId",value:function(){return++this._id}}]),e}(),Me=function(){function e(t){Object(s.a)(this,e),this._world=t,this.afterPositionUpdate=void 0,this.id=void 0,this.position=void 0,this.velocity=void 0,this.size=void 0,this.speed=void 0,this._steps=void 0,this._projectileMode=void 0,this._projectileOriginId=void 0,this._projectileOnHit=void 0,this.position=new f.Pb,this._steps=0,this.velocity=new f.Pb,this._projectileMode=!1,this._projectileOriginId=0,this._projectileOnHit=function(){},this.afterPositionUpdate=function(){}}return Object(o.a)(e,[{key:"rotationY",get:function(){return Math.atan2(this.velocity.x,this.velocity.z)}}]),Object(o.a)(e,[{key:"init",value:function(e,t,i,n){this.id=e,this.position.copy(t),this.size=i,this.speed=n,this._projectileMode||this.modifyCells(!0)}},{key:"setProjectileMode",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};this._projectileMode=e,this._projectileOriginId=t,this._projectileOnHit=i}},{key:"move",value:function(){if(this._projectileMode&&this._steps>0){var e=this.position.clone().add(this.velocity);this.canMoveTo(e)?this.moveTo(e):this._projectileOnHit()}else if(this._steps>0){var t=null,i=this.position.clone().add(new f.Pb(this.velocity.x,0,this.velocity.z));if(this.canMoveTo(i))t=i;else{var n=this.position.clone().add(new f.Pb(this.velocity.x,0,0));if(this.canMoveTo(n))t=n;else{var s=this.position.clone().add(new f.Pb(0,0,this.velocity.z));this.canMoveTo(s)&&(t=s)}}t?(this.moveTo(t),this._steps--):this._steps=0}}},{key:"startMovingTo",value:function(e){this._steps=Math.ceil(e.clone().sub(this.position).length()/this.speed),this.velocity.copy(e).sub(this.position).normalize().multiplyScalar(this.speed)}},{key:"canMoveTo",value:function(e){var t=this.size/2,i=e.clone();i.x-=t,i.z-=t;var n=this._world.map.convertToMapPosition(i),s=e.clone();s.x+=t,s.z+=t;var o=this._world.map.convertToMapPosition(s),a=[this.id];this._projectileMode&&a.push(this._projectileOriginId);for(var r=n.x;r<=o.x;r++)for(var l=n.z;l<=o.z;l++)if(!this._world.map.isCellPassable(r,l,a))return!1;return!0}},{key:"stop",value:function(){this._steps=0}},{key:"moveTo",value:function(e){this._projectileMode||this.modifyCells(!1),this.position.copy(e),this._projectileMode||this.modifyCells(!0),this.afterPositionUpdate()}},{key:"clearCells",value:function(){this.modifyCells(!1)}},{key:"modifyCells",value:function(e){var t=this.size/2,i=this.position.clone();i.x-=t,i.z-=t;var n=this._world.map.convertToMapPosition(i),s=this.position.clone();s.x+=t,s.z+=t;for(var o=this._world.map.convertToMapPosition(s),a=n.x;a<=o.x;a++)for(var r=n.z;r<=o.z;r++)e?this._world.map.getCell(a,r)&&this._world.map.occupyCell(a,r,this.id):this._world.map.getCell(a,r)&&this._world.map.vacateCell(a,r)}}]),e}(),Oe=i(1),Pe=i.n(Oe),je=i(10),Ae=i.n(je),Se=i(5),Te=i(4),Fe=i(6),De=i(7),Le={RefreshIntervalMs:33,ManaLightColor:"#2080c0",ManaDarkColor:"#002040",HealthLightColor:"#c02020",HealthDarkColor:"#400000",HighlightColor:"#bada55",ExperienceLightColor:"#c0c0c0",ExperienceDarkColor:"#202020"},ze=De.b.div.withConfig({displayName:"styles__Container",componentId:"sc-17sk688-0"})(["position:fixed;right:","px;top:","px;width:","px;height:","px;display:flex;flex-wrap:wrap;opacity:0.75;outline:2px solid #808080;user-select:none;"],32,32,256,256),Re=De.b.canvas.withConfig({displayName:"styles__Canvas",componentId:"sc-17sk688-1"})(["width:","px;height:","px;image-rendering:crisp-edges;image-rendering:pixelated;"],256,256),Ne=De.b.div.withConfig({displayName:"styles__PlayerDot",componentId:"sc-17sk688-2"})(["position:absolute;left:","px;top:","px;width:8px;height:8px;background:",";border-radius:4px;"],124,124,Le.HighlightColor),Ue=function(e){function t(e){var i;return Object(s.a)(this,t),(i=Object(Se.a)(this,Object(Te.a)(t).call(this,e)))._animationFrameId=void 0,i._canvasRef=void 0,i._ctx=void 0,i._canvasRef=Pe.a.createRef(),i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){this.draw()}},{key:"componentWillUnmount",value:function(){cancelAnimationFrame(this._animationFrameId)}},{key:"draw",value:function(){var e=this;this._animationFrameId=requestAnimationFrame(function(){return e.draw()});var t=performance.now();this.renderCells(),this.props.logger.logNumber("minimap draw time",performance.now()-t)}},{key:"renderCells",value:function(){var e=this.props,t=e.world,i=e.player;this._ctx||(this._ctx=this._canvasRef.current.getContext("2d",{alpha:!1}));for(var n=t.map.convertToMapPosition(i.position),s=this._ctx.getImageData(0,0,32,32),o={r:0,g:0,b:0},a=0;a<32;a++){for(var r=0;r<32;r++){var l=n.x+4*(-16+r),h=n.z+4*(-16+a),c=t.map.getCell(l,h);o.r=64,o.g=64,o.b=64,c&&c!==N.Void?c===N.Moving?(o.r=0,o.g=128,o.b=255):c===N.Concrete&&(o.r=255,o.g=255,o.b=255):(o.r=0,o.g=0,o.b=0),this.setPixel(s,r,a,o)}this._ctx.putImageData(s,0,0)}}},{key:"setPixel",value:function(e,t,i,n){var s=e.data,o=4*(32*i+t);s[o]=n.r,s[o+1]=n.g,s[o+2]=n.b,s[o+3]=255}},{key:"render",value:function(){return Pe.a.createElement(ze,null,Pe.a.createElement(Re,{ref:this._canvasRef,width:32,height:32}),Pe.a.createElement(Ne,null))}}]),t}(Oe.Component),He=De.b.div.withConfig({displayName:"styles__Text",componentId:"sc-170gzc-0"})(["position:fixed;bottom:","px;font-size:22px;color:#fff;text-shadow:2px 2px 0px #000;user-select:none;"],80),Be=De.b.div.withConfig({displayName:"styles__Container",componentId:"sc-170gzc-1"})(["position:fixed;bottom:","px;width:","px;height:","px;outline:2px solid #000;user-select:none;box-sizing:border-box;overflow:hidden;"],32,256,32),We=De.b.div.withConfig({displayName:"styles__Value",componentId:"sc-170gzc-2"})(["margin:3px;height:","px;"],22),Ve=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={health:100,totalHealth:100},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player;e.setState({health:t.health,totalHealth:t.totalHealth})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"render",value:function(){var e=this.state,t=e.health,i=e.totalHealth;return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(He,{style:{left:32}},t.toFixed(0)," / ",i.toFixed(0)),Pe.a.createElement(Be,{style:{left:32,border:"2px solid ".concat(Le.HealthLightColor),background:Le.HealthDarkColor}},Pe.a.createElement(We,{style:{width:Math.floor(t/i*246),background:Le.HealthLightColor}})))}}]),t}(Oe.PureComponent),Ke=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={mana:100,totalMana:100},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player;e.setState({mana:t.mana,totalMana:t.totalMana})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"render",value:function(){var e=this.state,t=e.mana,i=e.totalMana;return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(He,{style:{right:32}},t.toFixed(0)," / ",i.toFixed(0)),Pe.a.createElement(Be,{style:{right:32,border:"2px solid ".concat(Le.ManaLightColor),background:Le.ManaDarkColor}},Pe.a.createElement(We,{style:{width:Math.floor(t/i*246),background:Le.ManaLightColor}})))}}]),t}(Oe.PureComponent),qe=De.b.div.withConfig({displayName:"styles__SpellBarContainer",componentId:"sc-1rfqomb-0"})(["position:fixed;left:50%;transform:translateX(-50%);bottom:","px;user-select:none;box-sizing:border-box;color:#fff;display:flex;"],52),Ye=De.b.div.withConfig({displayName:"styles__IconOuter",componentId:"sc-1rfqomb-1"})(["position:relative;"]),Ge=De.b.div.withConfig({displayName:"styles__IconContainer",componentId:"sc-1rfqomb-2"})(["margin:4px;width:","px;height:","px;box-sizing:border-box;background:",";font-size:26px;position:relative;&:hover{box-shadow:inset 0px 0px 10px 0px rgba(255,255,255,1);}"],48,48,Le.ManaDarkColor),Xe=De.b.div.withConfig({displayName:"styles__IconInner",componentId:"sc-1rfqomb-3"})(["border:2px solid ",";width:","px;height:","px;box-sizing:border-box;display:flex;justify-content:center;align-items:center;"],Le.ManaLightColor,48,48),Ze=De.b.div.withConfig({displayName:"styles__IconBadge",componentId:"sc-1rfqomb-4"})(["position:absolute;left:50%;transform:translateX(-50%);outline:2px solid #000;top:-22px;font-size:12px;background:",";border:2px solid ",";width:32px;text-align:center;"],Le.ManaDarkColor,Le.ManaLightColor),Je=De.b.div.withConfig({displayName:"styles__IconCooldownOverlay",componentId:"sc-1rfqomb-5"})(["position:absolute;left:0;top:0;background:#000;opacity:0.75;width:","px;"],48),Qe=(i(33),function(e){var t=e.name,i=e.flip;return Pe.a.createElement("i",{style:{transform:i?"rotateY(180deg)":"none"},className:"ra ".concat(t)})});Qe.defaultProps={flip:!1};var $e=Qe,et=function(){function e(){Object(s.a)(this,e),this.name=void 0,this.manaCost=void 0,this.uncloakOnCast=void 0,this.iconName=void 0,this.flipIcon=void 0,this.tooltip=void 0,this._world=void 0,this._player=void 0,this._movementEngine=void 0,this._mouseControls=void 0,this.name="BaseSpell",this.manaCost=0,this.uncloakOnCast=!0,this.iconName="ra-sword",this.flipIcon=!1}return Object(o.a)(e,[{key:"init",value:function(e,t,i,n){this._world=e,this._player=t,this._movementEngine=i,this._mouseControls=n}},{key:"condition",value:function(){return!0}}]),e}(),tt=De.b.div.withConfig({displayName:"styles__Container",componentId:"sc-1yute5q-0"})(["display:block;width:256px;background:#000;color:#fff;font-size:16px;position:fixed;right:","px;bottom:160px;outline:2px solid #808080;opacity:0.75;padding:","px;user-select:none;box-sizing:border-box;"],32,16),it=De.b.div.withConfig({displayName:"styles__Header",componentId:"sc-1yute5q-1"})(["color:",";font-size:1.2em;"],Le.HighlightColor),nt=De.b.div.withConfig({displayName:"styles__Separator",componentId:"sc-1yute5q-2"})(["margin-bottom:10px;"]),st=De.b.span.withConfig({displayName:"Highlight",componentId:"sc-1uul1st-0"})(["font-weight:bold;color:",";"],Le.HighlightColor),ot=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Teleport"),Pe.a.createElement(nt,null),Pe.a.createElement(st,null,"5")," mana",Pe.a.createElement(nt,null),"Teleport to a chosen nearby location.")},e.name="Teleport",e.manaCost=5,e.iconName="ra-player-teleport",e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"cast",value:function(){this._movementEngine.canMoveTo(this._mouseControls.mapPosition)&&(this._movementEngine.velocity.copy(this._mouseControls.mapPosition).sub(this._movementEngine.position),this._movementEngine.moveTo(this._mouseControls.mapPosition))}}]),t}(et),at=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Cloak"),Pe.a.createElement(nt,null),"Turn invisible to enemies. Casting this or any spell will uncloak you.")},e.name="Cloak",e.uncloakOnCast=!1,e.iconName="ra-hood",e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"cast",value:function(){var e=this._player.auraEngine.hasAura(le.Cloaked);this._player.setInvisibility(!e)}}]),t}(et);var rt=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Touch of Death"),Pe.a.createElement(nt,null),Pe.a.createElement(st,null,"100")," mana",Pe.a.createElement(nt,null),"Instantly kill an enemy.")},e.name="Touch of Death",e.manaCost=100,e.iconName="ra-hand",e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"cast",value:function(){this._player.mouseOverTarget.damage()}},{key:"condition",value:function(){var e=this._player.mouseOverTarget;return e&&void 0!==e.damage&&!e.dead}}]),t}(et),lt=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Nova"),Pe.a.createElement(nt,null),Pe.a.createElement(st,null,"50")," mana",Pe.a.createElement(nt,null),"Throw ",Pe.a.createElement(st,null,"10")," orbs of green flame in a circle around you. Each orb explodes on impact for ",Pe.a.createElement(st,null,"50")," damage in a ",Pe.a.createElement(st,null,"3")," yard radius.")},e.name="Nova",e.manaCost=50,e.iconName="ra-sun-symbol",e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"cast",value:function(){for(var e=0;e<10;e++){var t=new f.Pb;t.x=Math.cos(Math.PI/180*e*36),t.z=Math.sin(Math.PI/180*e*36),t.add(this._movementEngine.position),this.throwProjectile(t)}}},{key:"throwProjectile",value:function(e){this._world.addProjectile({startPosition:this._movementEngine.position,targetPosition:e,speed:.5,color:new f.l(12245589),originEntityId:this._player.id,splashRadius:3})}}]),t}(et),ht=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Fireball"),Pe.a.createElement(nt,null),Pe.a.createElement(st,null,"10")," mana",Pe.a.createElement(nt,null),"Throw an orb of green flame. Explodes on impact for ",Pe.a.createElement(st,null,"50")," damage in a ",Pe.a.createElement(st,null,"3")," yard radius.")},e.name="Fireball",e.manaCost=10,e.iconName="ra-burning-meteor",e.flipIcon=!0,e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"cast",value:function(){this._movementEngine.velocity.copy(this._mouseControls.mousePosition).sub(this._movementEngine.position),this._player.updateMeshPosition(),this.throwProjectile()}},{key:"throwProjectile",value:function(){this._world.addProjectile({startPosition:this._movementEngine.position,targetPosition:this._mouseControls.mousePosition,speed:.5,color:new f.l(12245589),originEntityId:this._player.id,splashRadius:3})}}]),t}(et);var ct,ut=function(){function e(t,i){Object(s.a)(this,e),this._world=t,this._inputTracker=i,this.activeSpell=void 0,this.spells=void 0,this.globalCooldown=void 0,this._player=void 0,this._movementEngine=void 0,this._mouseControls=void 0,this._rightMouseDown=void 0,this.activeSpell=null,this.globalCooldown=0}return Object(o.a)(e,[{key:"init",value:function(e,t,i){var n=this;this._player=e,this._movementEngine=t,this._mouseControls=i,this._mouseControls.onRightClick=function(){return n._rightMouseDown=!0},this.initSpells()}},{key:"initSpells",value:function(){var e=this;this.spells=[{keybind:v.D1,spell:new at},{keybind:v.D2,spell:new lt},{keybind:v.D3,spell:new rt},{keybind:v.D4,spell:new ot},{keybind:v.RightMouseButton,spell:new ht}],this.spells.forEach(function(t){t.spell.init(e._world,e._player,e._movementEngine,e._mouseControls)})}},{key:"update",value:function(){if(this.globalCooldown>0)return this.globalCooldown--,this._rightMouseDown=!1,void(0===this.globalCooldown&&(this.activeSpell=null));for(var e=0;e<this.spells.length;e++){var t=this.spells[e],i=t.keybind,n=t.spell;if(i===v.RightMouseButton&&this._rightMouseDown||this._inputTracker.keysPressed[i]){this._player.mana>=n.manaCost&&n.condition()&&(this._movementEngine.stop(),this.globalCooldown=17,this._player.spendMana(n.manaCost),n.uncloakOnCast&&this._player.setInvisibility(!1),n.cast(),this.activeSpell=this.spells[e]);break}}this._rightMouseDown=!1}}]),e}(),dt=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).handleMouseEnter=function(){var e=i.props,t=e.tooltipService,n=e.data;t.show(n.spell.tooltip)},i.handleMouseLeave=function(){i.props.tooltipService.hide()},i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"render",value:function(){var e=this.props,t=e.data,i=e.active,n=e.cooldown,s=e.unusable;return Pe.a.createElement(Ye,null,Pe.a.createElement(Ze,null,g[t.keybind]),Pe.a.createElement(Ge,{onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,style:{outline:i?"2px solid #fff":"2px solid #000",filter:s?"brightness(0.25)":"none"}},Pe.a.createElement(Xe,null,Pe.a.createElement($e,{name:t.spell.iconName,flip:t.spell.flipIcon})),n>0&&Pe.a.createElement(Je,{style:{height:"".concat(Math.floor(n/17*48),"px")}})))}}]),t}(Oe.Component),mt=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={spells:[],activeSpell:null,globalCooldown:0,mana:0},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player,i=t.spellEngine,n=i.spells,s=i.activeSpell,o=i.globalCooldown;e.setState({mana:t.mana,spells:n,activeSpell:s,globalCooldown:o})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"render",value:function(){var e=this.props.tooltipService,t=this.state,i=t.spells,n=t.activeSpell,s=t.globalCooldown,o=t.mana;return Pe.a.createElement(qe,null,i.map(function(t,i){return Pe.a.createElement(dt,{key:i,data:t,active:t===n,cooldown:s,unusable:t.spell.manaCost>o,tooltipService:e})}))}}]),t}(Oe.PureComponent),pt=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={content:null},i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this.props.connector.onShow=function(t){e.setState({content:t})},this.props.connector.onHide=function(){e.setState({content:null})}}},{key:"componentWillUnmount",value:function(){this.props.connector.onShow=function(){},this.props.connector.onHide=function(){}}},{key:"render",value:function(){return this.state.content?Pe.a.createElement(tt,null,Pe.a.createElement(this.state.content,null)):null}}]),t}(Oe.PureComponent),vt=De.b.div.withConfig({displayName:"styles__Container",componentId:"mvh024-0"})(["position:fixed;left:50%;top:50%;transform:translateX(-50%) translateY(-50%);font-size:30px;user-select:none;padding:16px;text-align:center;text-shadow:2px 2px 0px #000;"]),gt=De.b.div.withConfig({displayName:"styles__Title",componentId:"mvh024-1"})(["font-size:2em;margin-bottom:32px;"]),yt=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={visible:!1},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player;e.setState({visible:t.dead})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"render",value:function(){return this.state.visible?Pe.a.createElement(vt,null,Pe.a.createElement(gt,null,"You died."),"Press ",Pe.a.createElement(st,null,"Enter")," to resurrect."):null}}]),t}(Oe.PureComponent),_t=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={experience:0,experienceToNextLevel:100},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player;e.setState({experience:t.experience,experienceToNextLevel:t.experienceToNextLevel})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"render",value:function(){var e=this.state,t=e.experience,i=e.experienceToNextLevel;return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(Be,{style:{width:272,height:16,left:"50%",transform:"translateX(-50%)",border:"2px solid ".concat(Le.ExperienceLightColor),background:Le.ExperienceDarkColor}},Pe.a.createElement(We,{style:{width:Math.floor(t/i*262),height:6,background:Le.ExperienceLightColor}})))}}]),t}(Oe.PureComponent),ft=Object(De.c)(["from{opacity:0;}"]),kt=Object(De.a)(["animation:"," 1s infinite alternate;"],ft),bt=De.b.div.withConfig({displayName:"styles__Container",componentId:"bm5n7g-0"})(["position:fixed;top:","px;right:","px;display:flex;user-select:none;"],30,306),xt=De.b.div.withConfig({displayName:"styles__IconContainer",componentId:"bm5n7g-1"})(["font-size:26px;margin-left:8px;width:","px;height:","px;display:flex;justify-content:center;align-items:center;border:2px solid ",";background:",";position:relative;"," &:hover{box-shadow:inset 0px 0px 5px 0px rgba(255,255,255,1);}"],32,32,Le.ManaLightColor,Le.ManaDarkColor,function(e){return e.flicker&&kt}),wt=De.b.div.withConfig({displayName:"styles__StackValue",componentId:"bm5n7g-2"})(["position:absolute;right:0;bottom:0;font-size:12px;text-shadow:2px 2px 0px #000;"]),Et=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).handleMouseEnter=function(){var e=i.props,t=e.tooltipService,n=e.aura;t.show(n.tooltip)},i.handleMouseLeave=function(){i.props.tooltipService.hide()},i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentWillUnmount",value:function(){var e=this.props,t=e.tooltipService,i=e.aura;t.current===i.tooltip&&t.hide()}},{key:"render",value:function(){var e=this.props.aura,t=e.iconName,i=e.flipIcon;return Pe.a.createElement(xt,{onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,flicker:e.isTimeBased()},Pe.a.createElement($e,{name:t,flip:i}),e.maxStacks>1&&Pe.a.createElement(wt,null,e.stacks))}}]),t}(Oe.Component),It=function(e){function t(){var e,i;Object(s.a)(this,t);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return(i=Object(Se.a)(this,(e=Object(Te.a)(t)).call.apply(e,[this].concat(o)))).state={auras:[],stacks:[]},i._intervalId=void 0,i}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"componentDidMount",value:function(){var e=this;this._intervalId=setInterval(function(){var t=e.props.player.auraEngine.auras;e.needsUpdate(t)&&e.setState({auras:t,stacks:t.map(function(e){return e.stacks})})},Le.RefreshIntervalMs)}},{key:"componentWillUnmount",value:function(){clearInterval(this._intervalId)}},{key:"needsUpdate",value:function(e){var t=this;return e.length!==this.state.auras.length||e.find(function(e,i){return e!==t.state.auras[i]||e.stacks!==t.state.stacks[i]})}},{key:"render",value:function(){var e=this,t=this.state.auras;return Pe.a.createElement(bt,null,t.map(function(t,i){return Pe.a.createElement(Et,{key:i,aura:t,tooltipService:e.props.tooltipService})}))}}]),t}(Oe.PureComponent),Ct=function(){function e(t,i,n,o){Object(s.a)(this,e),this._world=t,this._player=i,this._logger=n,this._tooltipService=o,Ae.a.render(Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(Ue,{world:this._world,player:this._player,logger:this._logger}),Pe.a.createElement(Ve,{player:this._player}),Pe.a.createElement(Ke,{player:this._player}),Pe.a.createElement(_t,{player:this._player}),Pe.a.createElement(mt,{player:this._player,tooltipService:this._tooltipService}),Pe.a.createElement(pt,{connector:this._tooltipService}),Pe.a.createElement(yt,{player:this._player}),Pe.a.createElement(It,{player:this._player,tooltipService:this._tooltipService})),document.getElementById("root"))}return Object(o.a)(e,[{key:"dispose",value:function(){Ae.a.unmountComponentAtNode(document.getElementById("root"))}}]),e}(),Mt=.5,Ot=10,Pt=3,jt="Projectile",At=function(){function e(t,i,n,o,a){Object(s.a)(this,e),this._world=t,this._entityId=i,this._movementEngine=n,this._pointLightCache=o,this._primitiveCache=a,this.id=void 0,this.toBeDeleted=void 0,this._mesh=void 0,this._data=void 0,this._exploded=void 0,this._explosionAnimationFrames=void 0,this._fadeInAnimationFrames=void 0,this._pointLightCacheItem=void 0,this._geometry=void 0,this.id=this._entityId.getNewId(),this.toBeDeleted=!1,this._explosionAnimationFrames=Ot,this._fadeInAnimationFrames=Pt,this._geometry=this._primitiveCache.getGeometry(jt,function(){return new f.Db(Mt)})}return Object(o.a)(e,[{key:"init",value:function(e){var t=this;this._data=e,this._movementEngine.setProjectileMode(!0,this._data.originEntityId,function(){return t.handleHit()}),this._movementEngine.init(this.id,e.startPosition,1,e.speed),this._movementEngine.afterPositionUpdate=function(){t.updateMeshPosition()},this.initMesh(),this._movementEngine.startMovingTo(this._data.targetPosition)}},{key:"update",value:function(){if(this._exploded){if(this._mesh.visible=!0,this._explosionAnimationFrames>0){this._explosionAnimationFrames--;var e=this._explosionAnimationFrames/Ot,t=1+(this._data.splashRadius-1)*(1-e);this._mesh.scale.set(t,t,t),this._pointLightCacheItem&&(this._pointLightCacheItem.pointLight.distance=(2-e)*this._data.splashRadius),0===this._explosionAnimationFrames&&(this.toBeDeleted=!0)}}else this._fadeInAnimationFrames>0&&(this._fadeInAnimationFrames--,0===this._fadeInAnimationFrames&&(this._mesh.visible=!0)),this._movementEngine.move()}},{key:"dispose",value:function(){this._pointLightCacheItem&&this._pointLightCache.free(this._pointLightCacheItem),this._world.removeMesh(this._mesh),this._mesh=null}},{key:"handleHit",value:function(){this._world.areaDamage(this._movementEngine.position,this._data.splashRadius,this._data.originEntityId),this._movementEngine.stop(),this._exploded=!0}},{key:"initMesh",value:function(){var e=new f.U({color:this._data.color});e.emissive.set(this._data.color),e.emissiveIntensity=3,this._mesh=new f.S(this._geometry,e),this._mesh.visible=!1,this._pointLightCacheItem=this._pointLightCache.allocate(),this._pointLightCacheItem&&(this._pointLightCacheItem.pointLight.intensity=3,this._pointLightCacheItem.pointLight.distance=this._data.splashRadius,this._pointLightCacheItem.pointLight.color.set(this._data.color)),this.updateMeshPosition(),this._world.addMesh(this._mesh)}},{key:"updateMeshPosition",value:function(){this._mesh.position.copy(this._movementEngine.position),this._mesh.position.y+=2,this._pointLightCacheItem&&(this._pointLightCacheItem.pointLight.position.copy(this._movementEngine.position),this._pointLightCacheItem.pointLight.position.y+=2)}}]),e}(),St=function(){function e(t){Object(s.a)(this,e),this._world=t,this._cache=void 0,this.initCache()}return Object(o.a)(e,[{key:"initCache",value:function(){this._cache={};for(var e=0;e<10;e++){var t={id:e+1,pointLight:new f.nb};this._cache[t.id]={free:!0,item:t},t.pointLight.intensity=0,t.pointLight.distance=0,this._world.addMesh(t.pointLight)}}},{key:"allocate",value:function(){var e=this.getFreeCacheItem();return e?(e.free=!1,e.item):null}},{key:"free",value:function(e){e.pointLight.intensity=0,e.pointLight.distance=0,this._cache[e.id].free=!0}},{key:"getFreeCacheItem",value:function(){for(var e=Object.keys(this._cache),t=0;t<e.length;t++){var i=e[t],n=this._cache[i];if(n.free)return n}return null}}]),e}(),Tt=Math.floor(15),Ft=function(){function e(){Object(s.a)(this,e),this.onHit=void 0,this._getTargetPosition=void 0,this._getTargetSize=void 0,this._mesh=void 0,this._movementEngine=void 0,this._size=void 0,this._originalPosition=void 0,this._animationFrames=void 0,this._offset=void 0,this._direction=void 0,this.onHit=function(){},this._originalPosition=new f.Pb,this._animationFrames=0,this._offset=new f.Pb,this._direction=new f.Pb}return Object(o.a)(e,[{key:"init",value:function(e,t,i,n,s){this._getTargetPosition=e,this._getTargetSize=t,this._mesh=i,this._movementEngine=n,this._size=s}},{key:"update",value:function(){}},{key:"isAttacking",value:function(){return this._animationFrames>0}},{key:"performAttack",value:function(){this._animationFrames--,this._movementEngine.startMovingTo(this._getTargetPosition()),this._direction.copy(this._movementEngine.velocity).normalize(),this._mesh.rotation.y=this._movementEngine.rotationY;var e=this._animationFrames/30;this._offset.x=Math.sin(Math.PI*e)*this._direction.x,this._offset.y=Math.sin(Math.PI*e)*this._size,this._offset.z=Math.sin(Math.PI*e)*this._direction.z,this._mesh.position.copy(this._originalPosition).add(this._offset),this._animationFrames===Tt&&this.canAttack()&&this.onHit()}},{key:"canAttack",value:function(){var e=2*(this._size/2+this._getTargetSize()/2);return this._movementEngine.position.distanceTo(this._getTargetPosition())<=e}},{key:"startAttacking",value:function(){this._originalPosition.copy(this._movementEngine.position),this._animationFrames=30}}]),e}(),Dt=function(){function e(){Object(s.a)(this,e),this._geometry=void 0,this._material=void 0,this._geometry={},this._material={}}return Object(o.a)(e,[{key:"getGeometry",value:function(e,t){return this._geometry[e]||(this._geometry[e]=t()),this._geometry[e]}},{key:"getMaterial",value:function(e,t){return this._material[e]||(this._material[e]=t()),this._material[e]}},{key:"dispose",value:function(){var e=this;Object.keys(this._geometry).forEach(function(t){e._geometry[t].dispose()}),this._geometry=null,Object.keys(this._material).forEach(function(t){e._material[t].dispose()}),this._material=null}}]),e}(),Lt=function(){function e(){Object(s.a)(this,e),this.onAnimationComplete=void 0,this._deathAnimationFrames=void 0,this._mesh=void 0,this._size=void 0,this.onAnimationComplete=function(){},this._deathAnimationFrames=0}return Object(o.a)(e,[{key:"init",value:function(e,t){this._mesh=e,this._size=t}},{key:"startAnimation",value:function(){this._deathAnimationFrames=30}},{key:"runAnimation",value:function(){if(this._deathAnimationFrames>0){this._deathAnimationFrames--;var e=this._deathAnimationFrames/30;this._mesh.rotation.x=-(1-e)*(Math.PI/2),this._mesh.position.y=this._size/4+Math.sin(Math.PI*e)*this._size,0===this._deathAnimationFrames&&this.onAnimationComplete()}}},{key:"cancelAnimation",value:function(){this._mesh.rotation.x=0,this._deathAnimationFrames=0}}]),e}(),zt=Math.floor(15),Rt=function(){function e(){Object(s.a)(this,e),this.onHit=void 0,this._getTargetPosition=void 0,this._canAttack=void 0,this._mesh=void 0,this._movementEngine=void 0,this._range=void 0,this._originalPosition=void 0,this._animationFrames=void 0,this._spellCooldownFrames=void 0,this._offset=void 0,this._direction=void 0,this.onHit=function(){},this._originalPosition=new f.Pb,this._animationFrames=0,this._spellCooldownFrames=0,this._offset=new f.Pb,this._direction=new f.Pb}return Object(o.a)(e,[{key:"init",value:function(e,t,i,n,s){this._getTargetPosition=e,this._canAttack=t,this._range=i,this._mesh=n,this._movementEngine=s}},{key:"update",value:function(){this._spellCooldownFrames>0&&this._spellCooldownFrames--}},{key:"isAttacking",value:function(){return this._animationFrames>0}},{key:"performAttack",value:function(){this._animationFrames--,this._movementEngine.startMovingTo(this._getTargetPosition()),this._direction.copy(this._movementEngine.velocity).normalize(),this._mesh.rotation.y=this._movementEngine.rotationY;var e=this._animationFrames/30;this._offset.x=-Math.sin(Math.PI*e)*this._direction.x,this._offset.z=-Math.sin(Math.PI*e)*this._direction.z,this._mesh.position.copy(this._originalPosition).add(this._offset),this._animationFrames===zt&&(this.canAttack()&&this.onHit(),this._spellCooldownFrames=120)}},{key:"canAttack",value:function(){return!(this._spellCooldownFrames>0)&&(this._movementEngine.position.distanceTo(this._getTargetPosition())<=this._range&&this._canAttack())}},{key:"startAttacking",value:function(){this._originalPosition.copy(this._movementEngine.position),this._animationFrames=30}}]),e}();!function(e){e[e.Open=1]="Open",e[e.Closed=2]="Closed",e[e.Opening=3]="Opening",e[e.Closing=4]="Closing"}(ct||(ct={}));var Nt=ct,Ut=function(){function e(t,i){Object(s.a)(this,e),this._world=t,this._entityId=i,this.id=void 0,this._rectangle=void 0,this._mesh=void 0,this._yDelta=void 0,this._animationFrames=void 0,this._state=void 0,this._collisionBox=void 0,this._defaultColor=void 0,this._highlightColor=void 0,this.id=this._entityId.getNewId(),this._yDelta=0,this._animationFrames=0,this._state=Nt.Closed}return Object(o.a)(e,[{key:"init",value:function(e,t){this._rectangle=e,this._mesh=t;var i=this._mesh.material;this._defaultColor=i.color.clone(),this._highlightColor=i.color.clone().multiplyScalar(10),this._world.addMesh(t),this.modifyCells(!0),this.initCollisionBox()}},{key:"setHighlight",value:function(e){this._mesh.material.color.copy(e?this._highlightColor:this._defaultColor)}},{key:"initCollisionBox",value:function(){this._collisionBox=(new f.g).setFromPoints([new f.Ob(this._rectangle.x0,this._rectangle.y0),new f.Ob(this._rectangle.x1,this._rectangle.y1)]),this._collisionBox.expandByScalar(3)}},{key:"update",value:function(){if(this._animationFrames>0)return this._animationFrames--,this._mesh.position.y+=this._yDelta,void(0===this._animationFrames&&(this._state===Nt.Closing?this._state=Nt.Closed:this._state===Nt.Opening&&(this._state=Nt.Open,this.modifyCells(!1))));Math.random()<.005&&this._state===Nt.Open&&this.close()}},{key:"open",value:function(){this._state===Nt.Closed&&(this._state=Nt.Opening,this._yDelta=-4/60,this._animationFrames=60)}},{key:"close",value:function(){this._state===Nt.Open&&this.canClose()&&(this._state=Nt.Closing,this._yDelta=4/60,this._animationFrames=60,this.modifyCells(!0))}},{key:"use",value:function(){this.open()}},{key:"canUse",value:function(e){return this._state===Nt.Closed&&this.isInRange(e)}},{key:"canHighlight",value:function(){return this._state===Nt.Closed}},{key:"isInRange",value:function(e){var t=this._world.map.convertToMapPosition(e);return this._collisionBox.containsPoint(new f.Ob(t.x,t.z))}},{key:"canClose",value:function(){for(var e=this._rectangle.x0;e<this._rectangle.x1;e++)for(var t=this._rectangle.y0;t<this._rectangle.y1;t++)if(!this._world.map.isCellPassable(e,t,[this.id]))return!1;return!0}},{key:"modifyCells",value:function(e){for(var t=this._rectangle.x0;t<this._rectangle.x1;t++)for(var i=this._rectangle.y0;i<this._rectangle.y1;i++)e?this._world.map.getCell(t,i)&&this._world.map.occupyCell(t,i,this.id):this._world.map.getCell(t,i)&&this._world.map.vacateCell(t,i)}}]),e}(),Ht=function(){function e(t){Object(s.a)(this,e),this._logger=t,this._visible=void 0,this._time=void 0,this._frames=void 0,this._visible=!1,this._time=performance.now(),this._frames=0}return Object(o.a)(e,[{key:"afterFrame",value:function(){this._frames++;var e=performance.now();e-this._time>1e3&&(this._visible&&this._logger.logBounds("fps",this._frames,0),this._time=e,this._frames=0)}},{key:"hide",value:function(){this._visible=!1}},{key:"show",value:function(){this._visible=!0}}]),e}(),Bt=function(){function e(){Object(s.a)(this,e),this.onShow=void 0,this.onHide=void 0,this.current=void 0,this.onShow=function(){},this.onHide=function(){},this.current=null}return Object(o.a)(e,[{key:"show",value:function(e){this.current=e,this.onShow(e)}},{key:"hide",value:function(){this.current=null,this.onHide()}}]),e}();function Wt(e){return void 0!==e.use}var Vt=function(){function e(){Object(s.a)(this,e),this._movementEngine=void 0,this._highlightTarget=void 0,this._willUse=void 0,this._highlightTarget=null,this._willUse=null}return Object(o.a)(e,[{key:"init",value:function(e){this._movementEngine=e}},{key:"afterPositionUpdate",value:function(){this._willUse&&this._willUse.canUse(this._movementEngine.position)&&(this._willUse.use(),this._willUse=null,this._movementEngine.stop())}},{key:"afterMouseOverTargetUpdate",value:function(e){e?this._highlightTarget!==e?Wt(e)&&e.canHighlight()&&(this._highlightTarget?this._highlightTarget.setHighlight(!1):(this._highlightTarget=e,this._highlightTarget.setHighlight(!0))):this._highlightTarget.canHighlight()||(this._highlightTarget.setHighlight(!1),this._highlightTarget=null):this._highlightTarget&&(this._highlightTarget.setHighlight(!1),this._highlightTarget=null)}},{key:"onLeftClick",value:function(e){e&&Wt(e)?this._willUse=e:this._willUse=null}}]),e}(),Kt=Object(m.a)({},fe.Energy,{geometryCacheKey:"PowerupEnergy",materialCacheKey:"PowerupEnergy",color:"#bada55"}),qt=2,Yt=function(){function e(t,i,n){Object(s.a)(this,e),this._world=t,this._entityId=i,this._primitiveCache=n,this.id=void 0,this.toBeDeleted=void 0,this.size=void 0,this.type=void 0,this._mesh=void 0,this._geometry=void 0,this._material=void 0,this._position=void 0,this._angle=void 0,this.id=this._entityId.getNewId(),this.toBeDeleted=!1,this.size=qt,this._position=new f.Pb,this._angle=0}return Object(o.a)(e,[{key:"init",value:function(e,t){this.type=e;var i=Kt[e];this._position.copy(t),this._geometry=this._primitiveCache.getGeometry(i.geometryCacheKey,function(){return new f.eb}),this._material=this._primitiveCache.getMaterial(i.materialCacheKey,function(){return new f.U({color:i.color})}),this.initMesh(),this.modifyCells(!0)}},{key:"update",value:function(){this._angle+=5,this._mesh.rotation.y+=.05,this._mesh.position.y=2+.5*Math.sin(Math.PI/180*this._angle),this._angle<180&&(this._mesh.position.y+=2*Math.sin(Math.PI/180*this._angle)),this._angle>=720&&(this._angle-=360)}},{key:"dispose",value:function(){this.modifyCells(!1),this._world.removeMesh(this._mesh),this._mesh=null}},{key:"occupyMapCells",value:function(){this.modifyCells(!0)}},{key:"markForDeletion",value:function(){this.toBeDeleted=!0}},{key:"initMesh",value:function(){this._mesh=new f.S(this._geometry,this._material),this._mesh.scale.set(1,1,1),this._mesh.rotation.order="ZYX",this._mesh.position.copy(this._position),this._mesh.position.y+=2,this._world.addMesh(this._mesh)}},{key:"modifyCells",value:function(e){var t=this.size/2,i=this._position.clone();i.x-=t,i.z-=t;var n=this._world.map.convertToMapPosition(i),s=this._position.clone();s.x+=t,s.z+=t;for(var o=this._world.map.convertToMapPosition(s),a=n.x;a<=o.x;a++)for(var r=n.z;r<=o.z;r++)e?this._world.map.getCell(a,r)&&this._world.map.occupyCell(a,r,this.id,V.Powerup):this._world.map.getCell(a,r)&&this._world.map.vacateCell(a,r,V.Powerup)}}]),e}(),Gt=function(){function e(){Object(s.a)(this,e),this.name=void 0,this.iconName=void 0,this.flipIcon=void 0,this.tooltip=void 0,this.ticks=void 0,this.totalTicks=void 0,this.stacks=void 0,this.maxStacks=void 0,this._player=void 0,this.name="BaseAura",this.iconName="ra-sword",this.flipIcon=!1,this.totalTicks=0,this.maxStacks=1,this.resetTicks(),this.resetStacks()}return Object(o.a)(e,[{key:"init",value:function(e){this._player=e}},{key:"tick",value:function(){this.ticks--}},{key:"resetTicks",value:function(){this.ticks=this.totalTicks}},{key:"resetStacks",value:function(){this.stacks=1}},{key:"isTimeBased",value:function(){return this.totalTicks>0}},{key:"addStack",value:function(){this.stacks<this.maxStacks&&this.stacks++}}]),e}(),Xt=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Cloaked"),Pe.a.createElement(nt,null),"Invisible to enemies.")},e.name="Cloaked",e.iconName="ra-hood",e}return Object(Fe.a)(t,e),t}(Gt),Zt=i(18),Jt=10,Qt=60/Jt;var $t=function(e){function t(){var e;return Object(s.a)(this,t),(e=Object(Se.a)(this,Object(Te.a)(t).call(this))).tooltip=function(){return Pe.a.createElement(Pe.a.Fragment,null,Pe.a.createElement(it,null,"Energized"),Pe.a.createElement(nt,null),"Gaining health and mana over time. Can stack.")},e.name="Energized",e.iconName="ra-lightning-bolt",e.totalTicks=5*Jt,e.maxStacks=20,e}return Object(Fe.a)(t,e),Object(o.a)(t,[{key:"tick",value:function(){Object(Zt.a)(Object(Te.a)(t.prototype),"tick",this).call(this),this._player.gainHealth(this.stacks/20),this._player.gainMana(this.stacks/10)}}]),t}(Gt);var ei=function(){function e(){Object(s.a)(this,e),this._auras=void 0,this._allAuras=void 0,this._player=void 0,this._tickFrames=void 0,this._auras=new Set,this._tickFrames=Qt}return Object(o.a)(e,[{key:"auras",get:function(){return Array.from(this._auras)}}]),Object(o.a)(e,[{key:"init",value:function(e){var t=this;this._player=e,this._allAuras=function(){var e;return e={},Object(m.a)(e,le.Cloaked,new Xt),Object(m.a)(e,le.Energized,new $t),e}(),Object.keys(this._allAuras).forEach(function(e){t._allAuras[e].init(t._player)})}},{key:"addAura",value:function(e){var t=this._allAuras[e];t.resetTicks(),t.maxStacks>1&&this._auras.has(t)?t.addStack():(t.resetStacks(),this._auras.add(t))}},{key:"removeAura",value:function(e){var t=this._allAuras[e];this._auras.delete(t)}},{key:"hasAura",value:function(e){var t=this._allAuras[e];return this._auras.has(t)}},{key:"clearAuras",value:function(){this._auras.clear()}},{key:"update",value:function(){this._tickFrames>0&&(this._tickFrames--,0===this._tickFrames&&(this._tickFrames=Qt,this.tick()))}},{key:"tick",value:function(){var e=this,t=[];this._auras.forEach(function(e){e.isTimeBased()&&(e.tick(),0===e.ticks&&t.push(e))}),t.forEach(function(t){return e._auras.delete(t)})}}]),e}(),ti=function(){function e(){Object(s.a)(this,e)}return Object(o.a)(e,[{key:"show",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Loading...",t=this.getDomElement();t||(t=this.constructDomElement()),t.innerHTML=e}},{key:"hide",value:function(){var e=this.getDomElement();e&&document.body.removeChild(e)}},{key:"getDomElement",value:function(){return document.getElementById("loading")}},{key:"constructDomElement",value:function(){var e=document.createElement("div");return e.id="loading",e.style.position="fixed",e.style.left="50%",e.style.top="50%",e.style.transform="translateX(-50%) translateY(-50%)",e.style.fontSize="30px",e.style.userSelect="none",e.style.textAlign="center",e.style.color="#fff",document.body.appendChild(e),e}}]),e}(),ii=function(){function e(){Object(s.a)(this,e),this.onUpdate=void 0,this.onDraw=void 0,this.afterFrame=void 0,this.onUpdate=function(){},this.onDraw=function(){},this.afterFrame=function(){}}return Object(o.a)(e,[{key:"run",value:function(){var e=this;requestAnimationFrame(function(){return e.run()}),this.onUpdate(),this.onDraw(),this.afterFrame()}}]),e}(),ni=new h;ni.registerSingleton(d.ILogger,_,d.IInputTracker),ni.registerSingleton(d.IAssetService,M),ni.registerSingleton(d.IInputTracker,P),ni.registerSingleton(d.ICore,_e,d.ILogger,r(d.IAssetService),d.IInputTracker,r(d.ICamera),r(d.IRenderer),r(d.IWorld),r(d.IPlayer),r(d.IUIRoot),d.IFpsDisplay,d.ILoadingDisplay,d.IGameLoop),ni.registerSingleton(d.ICamera,F),ni.registerSingleton(d.IRenderer,z),ni.register(d.IWorldMeshBuilder,W,d.IAssetService),ni.register(d.IMapLoader,se),ni.registerSingleton(d.IWorld,oe,d.IAssetService,d.IMapLoader,d.IWorldMeshBuilder,r(d.IMonster),r(d.IProjectile),d.ILogger,r(d.IPointLightCache),d.IPrimitiveCache,r(d.IDoor),r(d.IPowerup)),ni.register(d.IMouseControls,ae,d.ICamera,d.IInputTracker,d.IWorld,d.ILogger),ni.registerSingleton(d.IPlayer,ve,d.IMouseControls,d.ICamera,d.IInputTracker,d.IWorld,d.ILogger,d.IEntityId,d.IEntityMovementEngine,d.IAssetService,d.IEntityDeathAnimationEngine,d.IPlayerSpellEngine,d.IPlayerUseEngine,d.IPlayerAuraEngine),ni.register(d.IMonster,Ie,d.IWorld,d.IPlayer,d.IEntityId,d.IEntityMovementEngine,d.IAssetService,r(d.IEntityMeleeAttackEngine),r(d.IEntityRangedAttackEngine),d.IPrimitiveCache,d.IEntityDeathAnimationEngine),ni.registerSingleton(d.IEntityId,Ce),ni.register(d.IEntityMovementEngine,Me,d.IWorld),ni.registerSingleton(d.IUIRoot,Ct,d.IWorld,d.IPlayer,d.ILogger,d.ITooltipService),ni.register(d.IProjectile,At,d.IWorld,d.IEntityId,d.IEntityMovementEngine,d.IPointLightCache,d.IPrimitiveCache),ni.registerSingleton(d.IPointLightCache,St,d.IWorld),ni.register(d.IEntityMeleeAttackEngine,Ft),ni.registerSingleton(d.IPrimitiveCache,Dt),ni.register(d.IEntityDeathAnimationEngine,Lt),ni.register(d.IEntityRangedAttackEngine,Rt),ni.register(d.IDoor,Ut,d.IWorld,d.IEntityId),ni.register(d.IPlayerSpellEngine,ut,d.IWorld,d.IInputTracker),ni.register(d.IFpsDisplay,Ht,d.ILogger),ni.registerSingleton(d.ITooltipService,Bt),ni.register(d.IPlayerUseEngine,Vt),ni.register(d.IPowerup,Yt,d.IWorld,d.IEntityId,d.IPrimitiveCache),ni.register(d.IPlayerAuraEngine,ei),ni.register(d.ILoadingDisplay,ti),ni.register(d.IGameLoop,ii),ni.resolve(d.ICore).onRestart=function(){ni.disposeSingleton(d.ICamera),ni.disposeSingleton(d.IRenderer),ni.disposeSingleton(d.IWorld),ni.disposeSingleton(d.IPlayer),ni.disposeSingleton(d.IEntityId),ni.disposeSingleton(d.IUIRoot),ni.disposeSingleton(d.IPointLightCache),ni.disposeSingleton(d.IPrimitiveCache),ni.disposeSingleton(d.IAssetService),ni.disposeSingleton(d.ITooltipService)}}},[[21,1,2]]]);